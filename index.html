<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORGE | SKELETON SHELL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "three": "https://esm.sh/three@0.160.0",
                "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three",
                "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
                "uuid": "https://esm.sh/uuid@9.0.1"
            }
        }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; }
        ::-webkit-scrollbar-thumb { background: #455a64; border-radius: 2px; }
        body { overflow: hidden; background-color: #cfd8dc; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid #455a64; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mono-font { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Canvas, useThree, useLoader } from '@react-three/fiber';
        import { OrbitControls, Grid, Html, useCursor, TransformControls, OrthographicCamera, PerspectiveCamera } from '@react-three/drei';
        import { 
            Box, Layers, PenTool, Trash2, Download, MousePointer, Undo,
            Maximize, Settings, Save, ArrowUpCircle, Axis3d, Ruler, 
            DollarSign, FileText, ScanLine, Upload, Zap, Activity, Image as ImageIcon, FileImage, Palette, Link as LinkIcon, Calculator, HelpCircle, FileSpreadsheet, Frame, CircleDot
        } from 'lucide-react';
        import * as THREE from 'three';

        // --- 1. CONFIGURATION ---

        const THEME = {
            bg: '#cfd8dc',      // Technical Grey
            line: '#263238',    // Dark Blueprint
            selected: '#ff3d00', // Alert Orange
            grid: '#90a4ae',    // Drafting Grid
            guide: '#2962ff'    // Interaction Blue
        };

        const MATERIAL_LIBRARY = {
            'Reinf. Concrete': '#cfd8dc',
            'Engineered Timber': '#d7ccc8',
            'Steel H-Section': '#546e7a',
            'Mass Timber': '#a1887f',
            'Precast': '#eceff1',
            'Site/Earth': '#81c784',
            'Generic': '#f5f5f5'
        };

        const ELEMENT_DEFS = {
            SHELL_CONCRETE: { 
                type: 'SHELL_CONCRETE', label: 'Concrete Shell', layer: 'Enclosure', prefix: 'SH-C',
                defaultParams: { height: 3.5, thickness: 0.3, length: 1.0 }, 
                defaultSpecs: { material: 'Reinf. Concrete', costPerUnit: 350, costRatio: 1.0, manualQty: 0, fireRating: '3HR', omni: '21-00 00' },
                color: '#b0bec5' 
            },
            SHELL_TIMBER: { 
                type: 'SHELL_TIMBER', label: 'Timber Frame', layer: 'Partition', prefix: 'SH-T',
                defaultParams: { height: 3.0, thickness: 0.15, length: 1.0 }, 
                defaultSpecs: { material: 'Engineered Timber', costPerUnit: 180, costRatio: 1.0, manualQty: 0, fireRating: '1HR', omni: '21-00 00' },
                color: '#d7ccc8' 
            },
            STRUCT_NODE: { 
                type: 'STRUCT_NODE', label: 'Struct Node', layer: 'Skeleton', prefix: 'ND',
                defaultParams: { height: 3.5, width: 0.5, depth: 0.5 },
                defaultSpecs: { material: 'Steel H-Section', costPerUnit: 600, costRatio: 1.0, manualQty: 0, fireRating: '3HR', omni: '23-00 00' },
                color: '#ff7043'
            },
            TOPOGRAPHY: {
                type: 'TOPOGRAPHY', label: 'Site Mesh', layer: 'Site', prefix: 'TER',
                defaultParams: { width: 40, depth: 40, height: 8, segments: 128 }, 
                defaultSpecs: { material: 'Site/Earth', costPerUnit: 45, costRatio: 1.0, manualQty: 0, fireRating: 'N/A', omni: '31-00 00 00' },
                color: '#a5d6a7'
            }
        };

        const SVG_DEMO = `<svg width="200" height="200" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">\n  <line id="Shell-01" x1="2" y1="2" x2="18" y2="2" stroke="#455a64" stroke-width="2"/>\n  <circle id="Node-01" cx="2" cy="18" r="0.5" fill="#d84315" />\n</svg>`;

        // --- 2. ENGINE COMPONENTS ---

        const TopographyMesh = React.memo(({ element, dims, isSelected }) => {
            const texture = useMemo(() => {
                if (!element.data?.textureUrl) return null;
                return new THREE.TextureLoader().load(element.data.textureUrl);
            }, [element.data?.textureUrl]);

            return (
                <mesh rotation={[-Math.PI/2, 0, 0]}>
                    <planeGeometry args={[dims[0], dims[2], element.params.segments || 64, element.params.segments || 64]} />
                    <meshStandardMaterial 
                        color={element.color} 
                        displacementMap={texture}
                        displacementScale={dims[1]} 
                        wireframe={false}
                        roughness={0.9}
                        side={THREE.DoubleSide}
                    />
                    {isSelected && <lineSegments><wireframeGeometry args={[new THREE.PlaneGeometry(dims[0], dims[2], 10, 10)]} /><lineBasicMaterial color={THEME.selected} /></lineSegments>}
                </mesh>
            );
        });

        const BimElement = React.memo(({ element, isSelected, onSelect, mode, onTransformEnd }) => {
            const [hovered, setHover] = useState(false);
            const [mesh, setMesh] = useState(null);
            useCursor(hovered, 'pointer', 'auto');

            const dims = useMemo(() => {
                const p = element.params;
                if (element.type.startsWith('SHELL')) return [Math.max(0.1, p.length), Math.max(0.1, p.height), Math.max(0.05, p.thickness)];
                if (element.type === 'TOPOGRAPHY') return [Math.max(1, p.width), Math.max(0.1, p.height), Math.max(1, p.depth)];
                return [Math.max(0.1, p.width), Math.max(0.1, p.height), Math.max(0.1, p.depth)];
            }, [element.params, element.type]);

            const showGizmo = isSelected && ['translate', 'rotate'].includes(mode);
            const displayColor = isSelected ? THEME.selected : (element.color || MATERIAL_LIBRARY[element.specs.material] || '#cccccc');

            return (
                <group position={element.position} rotation={element.rotation}>
                    <group
                        ref={setMesh}
                        raycast={mode === 'draw' ? () => null : undefined} 
                        onClick={(e) => { 
                            if(mode !== 'draw') {
                                e.stopPropagation(); 
                                onSelect(element.id); 
                            }
                        }}
                        onPointerOver={() => mode !== 'draw' && setHover(true)}
                        onPointerOut={() => setHover(false)}
                    >
                        {element.type === 'TOPOGRAPHY' ? (
                            <TopographyMesh element={element} dims={dims} isSelected={isSelected} />
                        ) : (
                            <mesh>
                                <boxGeometry args={dims} />
                                <meshStandardMaterial color={displayColor} roughness={0.5} metalness={0.2} />
                                <lineSegments>
                                    <edgesGeometry args={[new THREE.BoxGeometry(...dims)]} />
                                    <lineBasicMaterial color={THEME.line} linewidth={1} transparent opacity={0.5} />
                                </lineSegments>
                            </mesh>
                        )}
                    </group>

                    {isSelected && (
                        <Html position={[0, dims[1]/2 + 0.5, 0]} center>
                            <div className="flex flex-col items-center pointer-events-none z-50">
                                <div className="bg-[#263238] text-white text-[10px] mono-font px-2 py-0.5 rounded shadow-lg whitespace-nowrap">
                                    {element.humanId}
                                </div>
                            </div>
                        </Html>
                    )}
                    {showGizmo && mesh && (
                        <TransformControls 
                            object={mesh} mode={mode === 'rotate' ? 'rotate' : 'translate'} size={0.8}
                            onMouseUp={(e) => { if (e?.target?.object) onTransformEnd(element.id, e.target.object); }}
                        />
                    )}
                </group>
            );
        });

        // Updated Ghost with Live Calculation
        const DrawGhost = ({ startPoint, endPoint, type }) => {
            if (!startPoint || !endPoint || !type || type === 'TOPOGRAPHY') return null;
            const dx = endPoint.x - startPoint.x;
            const dz = endPoint.z - startPoint.z;
            const len = Math.sqrt(dx*dx + dz*dz);
            if (len < 0.1) return null;
            
            const angle = Math.atan2(dx, dz);
            const midX = (startPoint.x + endPoint.x)/2;
            const midZ = (startPoint.z + endPoint.z)/2;
            const h = ELEMENT_DEFS[type].defaultParams.height;
            const t = ELEMENT_DEFS[type].defaultParams.thickness || 0.2;

            // Live Calculation
            const vol = len * h * t;
            const rate = ELEMENT_DEFS[type].defaultSpecs.costPerUnit;
            const estimatedCost = vol * rate;

            return (
                <group position={[midX, h/2, midZ]} rotation={[0, angle, 0]}>
                    <mesh raycast={() => null}>
                        <boxGeometry args={[t, h, len]} />
                        <meshStandardMaterial color={THEME.guide} opacity={0.4} transparent roughness={0.1} />
                        <lineSegments>
                            <edgesGeometry args={[new THREE.BoxGeometry(t, h, len)]} />
                            <lineBasicMaterial color={THEME.guide} linewidth={1} />
                        </lineSegments>
                    </mesh>
                    <Html position={[0, h/2 + 0.5, 0]} center>
                        <div className="flex flex-col items-center gap-1">
                            <div className="bg-blue-600 text-white text-xs px-2 py-1 rounded mono-font shadow-md font-bold">
                                {len.toFixed(2)}m
                            </div>
                            <div className="bg-green-700 text-white text-[10px] px-2 py-0.5 rounded mono-font shadow-md">
                                ${estimatedCost.toFixed(0)}
                            </div>
                        </div>
                    </Html>
                </group>
            );
        };

        // --- 3. UI HELPER COMPONENTS ---

        const HelpModal = ({ onClose }) => {
            const [tab, setTab] = useState('GUIDE');

            return (
                <div className="absolute inset-0 z-50 bg-black/60 flex items-center justify-center p-8 backdrop-blur-sm">
                    <div className="bg-[#eceff1] border-4 border-[#263238] rounded-2xl p-6 w-full max-w-2xl shadow-2xl flex flex-col max-h-full overflow-hidden">
                        <div className="flex justify-between items-start mb-4 shrink-0">
                            <h2 className="text-xl font-black flex items-center gap-2 text-[#263238]">
                                <HelpCircle className="text-blue-700" /> SYSTEM MANUAL
                            </h2>
                            <button onClick={onClose} className="text-[#263238] hover:text-red-600 font-bold">✕</button>
                        </div>

                        <div className="flex gap-4 mb-4 border-b-2 border-[#263238]/10 pb-2 shrink-0">
                            <button onClick={() => setTab('GUIDE')} className={`text-xs font-bold px-3 py-1 rounded-full transition ${tab === 'GUIDE' ? 'bg-[#263238] text-white' : 'hover:bg-gray-300'}`}>WORKFLOW</button>
                            <button onClick={() => setTab('ABOUT')} className={`text-xs font-bold px-3 py-1 rounded-full transition ${tab === 'ABOUT' ? 'bg-[#263238] text-white' : 'hover:bg-gray-300'}`}>KERNEL SPECS</button>
                        </div>
                        
                        <div className="overflow-y-auto pr-2 space-y-4 text-xs mono-font text-[#263238]">
                            {tab === 'GUIDE' ? (
                                <>
                                    <div className="p-3 bg-white rounded border border-[#263238]/20">
                                        <h3 className="font-bold text-sm mb-1">1. SKELETON MODELING</h3>
                                        <p className="mb-2 opacity-80">This tool uses a "vector-to-plane" logic. You draw 2D lines that instantly become 3D quantified shells.</p>
                                        <ul className="list-disc pl-4 opacity-80 space-y-1">
                                            <li><strong>Shell (Concrete/Timber):</strong> Click Start -> Click End. The system chains automatically for perimeters.</li>
                                            <li><strong>Nodes (Structure):</strong> Single click to place vertical structural elements.</li>
                                        </ul>
                                    </div>
                                    <div className="p-3 bg-white rounded border border-[#263238]/20">
                                        <h3 className="font-bold text-sm mb-1">2. LIVE SIM-CAL</h3>
                                        <p className="opacity-80">Cost is not an afterthought. As you drag your cursor, the tool calculates the Volume * Unit Cost in real-time, displaying the financial impact before you even click.</p>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="p-3 bg-white rounded border border-[#263238]/20">
                                        <h3 className="font-bold text-sm mb-1">FORGE KERNEL ARCHITECTURE</h3>
                                        <p className="mb-2 opacity-80">A streamlined BIM shell designer focusing on the intersection of Architecture, Structure, and Finance.</p>
                                        <ul className="list-disc pl-4 opacity-80 space-y-1">
                                            <li><strong>Entity:</strong> Shell (Enclosure) & Node (Support)</li>
                                            <li><strong>Data:</strong> Parametric JSON State</li>
                                            <li><strong>Output:</strong> Geometric Mesh + CSV Cost Schedule</li>
                                        </ul>
                                    </div>
                                </>
                            )}
                        </div>

                        <button onClick={onClose} className="mt-6 w-full py-3 bg-[#263238] text-white font-bold rounded-xl hover:bg-[#37474f] transition shrink-0">
                            INITIALIZE SYSTEM
                        </button>
                    </div>
                </div>
            );
        };

        // --- 4. LOGIC & STATE ---

        function ForgeBimApp() {
            const [elements, setElements] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [mode, setMode] = useState('select'); 
            const [cameraView, setCameraView] = useState('3D');
            const [drawState, setDrawState] = useState({ active: false, startPoint: null, endPoint: null, type: null });
            const [showImport, setShowImport] = useState(false);
            const [showHelp, setShowHelp] = useState(true);
            const [svgInput, setSvgInput] = useState(SVG_DEMO);
            const fileInputRef = useRef(null);

            const selectedElement = useMemo(() => elements.find(e => e.id === selectedId), [elements, selectedId]);

            const getAutoQty = useCallback((el) => {
                if (!el) return 0;
                const p = el.params;
                if (el.type.startsWith('SHELL')) return p.length * p.height * p.thickness;
                if (el.type === 'TOPOGRAPHY') return p.width * p.depth * (p.height * 0.5);
                return p.width * p.height * p.depth;
            }, []);

            const getEffectiveQty = useCallback((el) => {
                if (!el) return 0;
                const manual = parseFloat(el.specs.manualQty);
                return (manual && manual > 0) ? manual : getAutoQty(el);
            }, [getAutoQty]);

            const getElementCost = useCallback((el) => {
                if (!el) return 0;
                const qty = getEffectiveQty(el);
                const rate = el.specs.costPerUnit || 0;
                const ratio = el.specs.costRatio || 1.0;
                return qty * rate * ratio;
            }, [getEffectiveQty]);

            const stats = useMemo(() => {
                let vol = 0, cost = 0;
                elements.forEach(el => {
                    vol += getAutoQty(el); 
                    cost += getElementCost(el);
                });
                return { vol, cost };
            }, [elements, getAutoQty, getElementCost]);

            const generateID = (type, count) => {
                const def = ELEMENT_DEFS[type] || { prefix: 'OBJ' };
                return `${def.prefix}-${(count + 1).toString().padStart(3, '0')}`;
            };

            const parseSVG = () => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgInput, "image/svg+xml");
                const newEls = [];
                let count = elements.length;
                
                doc.querySelectorAll('line').forEach(line => {
                    const x1 = parseFloat(line.getAttribute('x1')); const y1 = parseFloat(line.getAttribute('y1'));
                    const x2 = parseFloat(line.getAttribute('x2')); const y2 = parseFloat(line.getAttribute('y2'));
                    if(isNaN(x1)) return;
                    const dx = x2 - x1; const dz = y2 - y1;
                    const len = Math.sqrt(dx*dx + dz*dz);
                    const angle = Math.atan2(dx, dz);
                    const midX = (x1 + x2)/2; const midZ = (y1 + y2)/2;
                    const offsetX = midX - 10; const offsetZ = midZ - 10;
                    const def = ELEMENT_DEFS.SHELL_CONCRETE;
                    newEls.push({
                        id: crypto.randomUUID(), humanId: generateID(def.type, count++),
                        type: def.type, label: def.label, color: def.color,
                        params: { ...def.defaultParams, length: len }, specs: { ...def.defaultSpecs },
                        position: [offsetX, def.defaultParams.height/2, offsetZ], rotation: [0, angle, 0], parentId: null
                    });
                });
                // Simplified SVG parsing for demo...
                setElements(prev => [...prev, ...newEls]);
                setShowImport(false);
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                if (file.type.includes('image')) {
                    reader.onload = (ev) => {
                        const dataUrl = ev.target.result;
                        const def = ELEMENT_DEFS.TOPOGRAPHY;
                        const newEl = {
                            id: crypto.randomUUID(), humanId: generateID('TOPOGRAPHY', elements.length),
                            type: def.type, label: `${def.label} (${file.name})`, color: def.color,
                            params: { ...def.defaultParams }, specs: { ...def.defaultSpecs },
                            data: { textureUrl: dataUrl }, position: [0, 0, 0], rotation: [0, 0, 0], parentId: null
                        };
                        setElements(prev => [...prev, newEl]);
                        setShowImport(false);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleDrawClick = (pt) => {
                const count = elements.length;
                if (drawState.type === 'STRUCT_NODE') {
                    const def = ELEMENT_DEFS[drawState.type];
                    const el = {
                        id: crypto.randomUUID(), humanId: generateID(def.type, count),
                        type: def.type, label: def.label, color: def.color,
                        params: { ...def.defaultParams }, specs: { ...def.defaultSpecs },
                        position: [pt.x, def.defaultParams.height/2, pt.z], rotation: [0,0,0], parentId: null
                    };
                    setElements(prev => [...prev, el]);
                    setSelectedId(el.id);
                } else {
                    if (!drawState.active) {
                        setDrawState(prev => ({ ...prev, active: true, startPoint: pt, endPoint: pt }));
                    } else {
                        const start = drawState.startPoint;
                        const end = pt;
                        const dx = end.x - start.x; const dz = end.z - start.z;
                        const len = Math.sqrt(dx*dx + dz*dz);
                        
                        if(len > 0.1) {
                            const angle = Math.atan2(dx, dz);
                            const midX = (start.x + end.x)/2; const midZ = (start.z + end.z)/2;
                            const def = ELEMENT_DEFS[drawState.type];
                            const el = {
                                id: crypto.randomUUID(), humanId: generateID(def.type, count),
                                type: def.type, label: def.label, color: def.color,
                                params: { ...def.defaultParams, length: len },
                                specs: { ...def.defaultSpecs },
                                position: [midX, def.defaultParams.height/2, midZ],
                                rotation: [0, angle, 0], parentId: null
                            };
                            setElements(prev => [...prev, el]);
                            setSelectedId(el.id);
                            setDrawState(prev => ({ ...prev, startPoint: end, endPoint: end }));
                        }
                    }
                }
            };

            const SceneManager = ({ 
                elements, setElements, selectedId, setSelectedId, mode, setMode,
                drawState, setDrawState, cameraView
            }) => {
                const snapToGrid = (val) => Math.round(val * 2) / 2;

                useEffect(() => {
                    const handleKeyDown = (e) => {
                        if (e.key === 'Escape') {
                            if (drawState.active && drawState.startPoint) {
                                setDrawState(prev => ({ ...prev, active: false, startPoint: null, endPoint: null }));
                            } else {
                                setDrawState({ active: false, startPoint: null, endPoint: null, type: null });
                                setMode('select');
                            }
                        }
                    };
                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }, [drawState, setMode]);

                const onMove = (e) => {
                    if (mode === 'draw') {
                        e.stopPropagation();
                        const snappedX = snapToGrid(e.point.x);
                        const snappedZ = snapToGrid(e.point.z);
                        setDrawState(prev => {
                            if (!prev.endPoint || prev.endPoint.x !== snappedX || prev.endPoint.z !== snappedZ) {
                                return { ...prev, endPoint: new THREE.Vector3(snappedX, 0, snappedZ) };
                            }
                            return prev;
                        });
                    }
                };

                const onClick = (e) => {
                    e.stopPropagation();
                    if (mode === 'draw') {
                        const snapped = new THREE.Vector3(snapToGrid(e.point.x), 0, snapToGrid(e.point.z));
                        handleDrawClick(snapped);
                    } else if (selectedId) setSelectedId(null);
                };

                const onTransform = useCallback((id, obj) => {
                    setElements(prev => prev.map(el => {
                        if (el.id === id) return { 
                            ...el, 
                            position: [obj.position.x, obj.position.y, obj.position.z], 
                            rotation: [obj.rotation.x, obj.rotation.y, obj.rotation.z] 
                        };
                        return el;
                    }));
                }, []);

                return (
                    <>
                        <mesh 
                            rotation={[-Math.PI/2, 0, 0]} 
                            position={[0, -0.01, 0]} 
                            onClick={onClick}
                            onPointerMove={onMove}
                            visible={false}
                        >
                            <planeGeometry args={[10000, 10000]} />
                        </mesh>
                        <Grid 
                            infiniteGrid 
                            cellSize={1} 
                            sectionSize={5} 
                            sectionColor={THEME.line} 
                            cellColor={THEME.grid} 
                            fadeDistance={cameraView === '2D' ? 500 : 200}
                            position={[0, 0, 0]}
                        />
                        
                        {elements.map(el => (
                            <BimElement 
                                key={el.id} element={el} isSelected={selectedId === el.id} 
                                onSelect={setSelectedId} mode={mode} onTransformEnd={onTransform} 
                            />
                        ))}

                        {mode === 'draw' && drawState.active && <DrawGhost startPoint={drawState.startPoint} endPoint={drawState.endPoint} type={drawState.type} />}
                        
                        {mode === 'draw' && (
                            <>
                                {drawState.active && drawState.startPoint && (
                                    <mesh position={drawState.startPoint} raycast={() => null}>
                                        <sphereGeometry args={[0.15]} />
                                        <meshBasicMaterial color={THEME.guide} />
                                    </mesh>
                                )}
                                {drawState.endPoint && (
                                    <mesh position={drawState.endPoint} raycast={() => null}>
                                        <sphereGeometry args={[0.1]} />
                                        <meshBasicMaterial color={THEME.selected} opacity={0.5} transparent />
                                    </mesh>
                                )}
                            </>
                        )}
                    </>
                );
            };

            const updateParam = (key, value) => {
                if (!selectedId) return;
                setElements(prev => prev.map(el => el.id === selectedId ? { ...el, params: { ...el.params, [key]: parseFloat(value) || 0.1 } } : el));
            };

            const updateSpec = (key, value) => {
                if (!selectedId) return;
                setElements(prev => prev.map(el => {
                    if (el.id === selectedId) {
                        const newSpecs = { ...el.specs, [key]: value };
                        let newColor = el.color;
                        if (key === 'material' && MATERIAL_LIBRARY[value]) newColor = MATERIAL_LIBRARY[value];
                        return { ...el, specs: newSpecs, color: newColor };
                    }
                    return el;
                }));
            };

            const updateColor = (value) => {
                if (!selectedId) return;
                setElements(prev => prev.map(el => el.id === selectedId ? { ...el, color: value } : el));
            };

            const updateParent = (val) => {
                if (!selectedId) return;
                setElements(prev => prev.map(el => el.id === selectedId ? { ...el, parentId: val } : el));
            }

            const deleteSelected = () => {
                setElements(prev => prev.filter(e => e.id !== selectedId));
                setSelectedId(null);
            };

            const handleExport = () => {
                const data = JSON.stringify(elements, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'forge_bim_data.json';
                a.click();
            };

            const handleExportCSV = () => {
                const headers = ["ID", "Type", "Label", "Material", "Dims", "Cost"];
                const rows = elements.map(el => {
                    const cost = getElementCost(el);
                    const dims = el.type.startsWith('SHELL') ? `${el.params.length.toFixed(2)}x${el.params.height.toFixed(2)}` : 'N/A';
                    return [`"${el.humanId}"`, `"${el.type}"`, `"${el.label}"`, `"${el.specs.material}"`, `"${dims}"`, `"${cost.toFixed(2)}"`].join(",");
                });
                const csvContent = [headers.join(","), ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `forge_cost_schedule.csv`;
                a.click();
            };

            const startDrawing = (type) => {
                setSelectedId(null);
                setMode('draw');
                setDrawState({ active: false, startPoint: null, endPoint: null, type });
            };

            return (
                <div className="w-full h-screen bg-[#cfd8dc] text-[#263238] mono-font flex flex-col overflow-hidden relative select-none">
                    
                    {/* HEADER */}
                    <div className="absolute top-4 left-4 right-4 z-10 flex justify-between pointer-events-none">
                        <div className="flex gap-2 pointer-events-auto">
                            <button onClick={() => setShowHelp(true)} className="glass-panel w-10 h-10 rounded-full font-bold shadow-lg hover:bg-white transition flex items-center justify-center text-[#263238]">
                                <HelpCircle size={18} />
                            </button>
                            <button onClick={() => setCameraView(v => v === '2D' ? '3D' : '2D')} className="glass-panel px-4 py-2 rounded-full font-bold shadow-lg hover:bg-white transition flex items-center gap-2 text-xs">
                                <ScanLine size={16}/> {cameraView}
                            </button>
                            <button onClick={() => setShowImport(true)} className="glass-panel px-4 py-2 rounded-full font-bold shadow-lg hover:bg-white transition flex items-center gap-2 text-xs text-blue-800">
                                <Upload size={16}/> IMPORT
                            </button>
                        </div>
                        
                        <div className="glass-panel px-6 py-2 rounded-lg shadow-lg pointer-events-auto flex flex-col items-center justify-center">
                            <h1 className="text-xl font-black tracking-widest leading-none">FORGE | SKELETON SHELL</h1>
                            <div className="text-[10px] font-bold tracking-[0.2em] opacity-60">SYSTEM INTEGRATOR</div>
                        </div>
                        
                        <div className="pointer-events-auto">
                            <div className="glass-panel rounded-xl p-3 shadow-xl flex gap-6 text-xs min-w-[300px]">
                                <div>
                                    <div className="font-bold opacity-50 mb-1 flex items-center gap-1"><Activity size={12}/> VOL (m³)</div>
                                    <div className="text-lg font-bold">{stats.vol.toFixed(2)}</div>
                                </div>
                                <div className="border-r border-[#455a64] opacity-20"></div>
                                <div>
                                    <div className="font-bold opacity-50 mb-1 flex items-center gap-1"><DollarSign size={12}/> COST ($)</div>
                                    <div className="text-lg font-bold text-green-800">${stats.cost.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* MODALS */}
                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    {showImport && (
                        <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-8 backdrop-blur-sm">
                            <div className="glass-panel rounded-2xl p-6 w-full max-w-xl shadow-2xl">
                                <h2 className="text-lg font-black mb-4">IMPORT DATA</h2>
                                <div className="flex gap-4 mb-4">
                                    <button onClick={() => fileInputRef.current.click()} className="flex-1 p-8 border-2 border-dashed border-[#455a64]/30 rounded-xl hover:bg-white/50 flex flex-col items-center">
                                        <FileImage size={32} className="mb-2 opacity-50"/>
                                        <span className="font-bold text-xs">UPLOAD FILE</span>
                                        <span className="text-[9px] opacity-60">.SVG (Vector) or .JPG (Terrain)</span>
                                    </button>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".svg,.png,.jpg,.jpeg" onChange={handleFileSelect} />
                                </div>
                                <button onClick={() => setShowImport(false)} className="w-full py-2 rounded border border-[#455a64] hover:bg-gray-200 font-bold text-xs">CLOSE</button>
                            </div>
                        </div>
                    )}

                    {/* WORKSPACE */}
                    <div className="flex-1 flex gap-4 p-4 pt-20">
                        {/* TOOLBAR */}
                        <div className="w-16 glass-panel rounded-2xl flex flex-col items-center py-4 gap-3 shadow-lg z-0">
                            <ToolBtn icon={MousePointer} active={mode==='select'} onClick={() => setMode('select')} label="SEL" />
                            <div className="w-8 border-b border-[#455a64] opacity-20"></div>
                            <ToolBtn icon={Frame} active={mode==='draw' && drawState.type==='SHELL_CONCRETE'} onClick={()=>{startDrawing('SHELL_CONCRETE')}} label="SHELL" />
                            <ToolBtn icon={Frame} active={mode==='draw' && drawState.type==='SHELL_TIMBER'} onClick={()=>{startDrawing('SHELL_TIMBER')}} label="FRAME" />
                            <ToolBtn icon={CircleDot} active={mode==='draw' && drawState.type==='STRUCT_NODE'} onClick={()=>{startDrawing('STRUCT_NODE')}} label="NODE" />
                            <div className="w-8 border-b border-[#455a64] opacity-20"></div>
                            <ToolBtn icon={Axis3d} active={mode==='translate'} onClick={() => setMode('translate')} label="MOV" />
                            <ToolBtn icon={ArrowUpCircle} active={mode==='rotate'} onClick={() => setMode('rotate')} label="ROT" />
                            <div className="mt-auto"><ToolBtn icon={Undo} onClick={()=>{}} label="UNDO" /></div>
                        </div>

                        {/* CANVAS */}
                        <div className="flex-1 glass-panel rounded-3xl overflow-hidden relative shadow-inner bg-[#eceff1]">
                            <Canvas shadows dpr={[1, 2]}>
                                <color attach="background" args={['#eceff1']} />
                                {cameraView === '3D' ? <PerspectiveCamera makeDefault position={[12, 16, 12]} fov={40} /> : <OrthographicCamera makeDefault position={[0, 60, 0]} zoom={30} />}
                                <OrbitControls makeDefault enableRotate={cameraView==='3D'} enableDamping={false} />
                                <SceneManager 
                                    elements={elements} setElements={setElements}
                                    selectedId={selectedId} setSelectedId={setSelectedId}
                                    mode={mode} setMode={setMode}
                                    drawState={drawState} setDrawState={setDrawState}
                                    cameraView={cameraView}
                                />
                            </Canvas>
                        </div>

                        {/* PROPERTIES */}
                        <div className="w-72 glass-panel rounded-2xl flex flex-col shadow-lg overflow-hidden">
                            <div className="bg-[#455a64] text-white px-4 py-2 font-bold text-xs tracking-widest flex items-center gap-2">
                                <Settings size={12}/> COMPONENT DATA
                            </div>
                            <div className="flex-1 overflow-auto p-4 scrollbar-hide">
                                {selectedElement ? (
                                    <div className="space-y-4">
                                        <div className="bg-white/50 p-2 rounded border border-[#455a64]/20">
                                            <div className="text-xs font-bold uppercase tracking-wider">{selectedElement.label}</div>
                                            <div className="text-[10px] opacity-60 font-mono tracking-tighter">{selectedElement.humanId}</div>
                                        </div>

                                        <Group title="SPECIFICATION" icon={FileText}>
                                            <Field label="OMNICLASS" value={selectedElement.specs.omni} readOnly />
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="font-bold opacity-80">MATERIAL</span>
                                                <select 
                                                    value={selectedElement.specs.material} 
                                                    onChange={(e) => updateSpec('material', e.target.value)}
                                                    className="w-28 bg-transparent border-b border-[#455a64] text-right focus:outline-none font-mono text-[10px]"
                                                >
                                                    {Object.keys(MATERIAL_LIBRARY).map(mat => (
                                                        <option key={mat} value={mat}>{mat}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </Group>

                                        <Group title="DIMENSIONS" icon={Ruler}>
                                            {selectedElement.type.startsWith('SHELL') ? (
                                                <>
                                                    <Field label="LENGTH (m)" value={selectedElement.params.length.toFixed(2)} onChange={v => updateParam('length', v)}/>
                                                    <Field label="HEIGHT (m)" value={selectedElement.params.height} onChange={v => updateParam('height', v)}/>
                                                    <Field label="THICK (m)" value={selectedElement.params.thickness} onChange={v => updateParam('thickness', v)}/>
                                                </>
                                            ) : (
                                                <>
                                                    <Field label="HEIGHT (m)" value={selectedElement.params.height} onChange={v => updateParam('height', v)}/>
                                                    <Field label="WIDTH (m)" value={selectedElement.params.width} onChange={v => updateParam('width', v)}/>
                                                </>
                                            )}
                                        </Group>

                                        <Group title="SIM-CAL COST" icon={Calculator} hl>
                                            <LabeledInput label="UNIT RATE ($)" value={selectedElement.specs.costPerUnit} onChange={v => updateSpec('costPerUnit', v)} />
                                            <div className="flex justify-between text-sm font-bold border-t border-[#455a64]/20 pt-1 mt-1">
                                                <span>TOTAL</span>
                                                <span className="text-green-700">
                                                    ${getElementCost(selectedElement).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                </span>
                                            </div>
                                        </Group>

                                        <button onClick={deleteSelected} className="w-full py-2 mt-4 bg-red-100 text-red-800 border border-red-300 rounded hover:bg-red-200 text-xs font-bold flex items-center justify-center gap-2">
                                            <Trash2 size={12}/> DELETE
                                        </button>
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center opacity-30">
                                        <MousePointer size={32} />
                                        <p className="text-xs mt-2 text-center font-bold">SELECT COMPONENT</p>
                                    </div>
                                )}
                            </div>
                            <div className="p-3 border-t border-[#455a64]/20">
                                <button onClick={handleExportCSV} className="w-full py-2 bg-green-700 text-white font-bold rounded-md shadow-md flex items-center justify-center gap-2 text-xs hover:bg-green-600 transition">
                                    <FileSpreadsheet className="w-3 h-3" /> EXPORT SCHEDULE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const ToolBtn = ({ icon: Icon, active, onClick, label }) => (
            <button onClick={onClick} className={`w-10 h-10 rounded-lg flex flex-col items-center justify-center transition-all ${active ? 'bg-[#455a64] text-white shadow-inner' : 'hover:bg-[#455a64]/10 text-[#455a64]'}`}>
                <Icon size={18} strokeWidth={2.5} />
                <span className="text-[8px] font-bold mt-0.5">{label}</span>
            </button>
        );

        const Group = ({ title, icon: Icon, children, hl }) => (
            <div className={`rounded border border-[#455a64]/30 p-2 ${hl ? 'bg-blue-50/50' : ''}`}>
                <div className="text-[10px] font-bold opacity-60 mb-2 flex items-center gap-1"><Icon size={10}/> {title}</div>
                <div className="space-y-2">{children}</div>
            </div>
        );

        const Field = ({ label, value, onChange, readOnly }) => (
            <div className="flex justify-between items-center text-xs">
                <span className="font-bold opacity-80">{label}</span>
                {readOnly ? (
                    <span className="font-mono opacity-60">{value}</span>
                ) : (
                    <input type="number" step="0.1" value={value} onChange={e => onChange(e.target.value)} className="w-16 bg-transparent border-b border-[#455a64] text-right focus:outline-none font-mono"/>
                )}
            </div>
        );

        const LabeledInput = ({ label, value, onChange }) => (
            <div className="flex justify-between items-center text-xs">
                <span className="font-bold opacity-80">{label}</span>
                <input type="number" step="0.1" value={value} onChange={e => onChange(e.target.value)} className="w-16 bg-transparent border-b border-[#455a64] text-right focus:outline-none font-mono"/>
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<ForgeBimApp />);
    </script>
</body>
</html>
